<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bot-Flow Builder</title>
<!-- Rete.js Styles -->
<link rel="stylesheet" href="https://unpkg.com/rete/dist/rete.min.css" />
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  #rete { width: 100%; height: 80vh; border: 1px solid #ccc; }
  button { margin-top: 10px; margin-right: 10px; }
  #output { white-space: pre-wrap; background:#f0f0f0; padding:10px; margin-top:10px; height:150px; overflow:auto; }
</style>
</head>
<body>

<h1>Bot-Flow Builder</h1>
<div id="rete"></div>
<button id="add-node">Node hinzufügen</button>
<button id="save">Flow speichern</button>
<pre id="output"></pre>

<!-- Rete.js und Plugins -->
<script src="https://unpkg.com/rete/dist/rete.min.js"></script>
<script src="https://unpkg.com/rete-connection-plugin/dist/rete-connection-plugin.min.js"></script>
<script src="https://unpkg.com/rete-area-plugin/dist/rete-area-plugin.min.js"></script>

<script>
(async () => {
  const container = document.querySelector('#rete');

  // Node-Komponenten
  class TextNode extends Rete.Component {
    constructor() { super("Text"); }
    builder(node) {
      const out = new Rete.Output('text', 'Text');
      let ctrl = new Rete.Control('text', {
        component: class extends Rete.Control {
          constructor(emitter, key) {
            super(key);
            this.render = 'input';
            this.key = key;
            this.emitter = emitter;
            this.data = { text: 'Begrüßung' };
            this.putData(this.data);
          }
          mounted() { this.update(); }
          setValue(val) {
            this.data.text = val;
            this.putData(this.data);
            this.emitter.trigger('process');
          }
          update() {
            this.putData(this.key, this.data.text);
          }
          render() {
            return `<input type="text" style="width:100%;" value="${this.data.text}" oninput="this.parentNode.control.setValue(this.value)" />`;
          }
        }
      }, 'text');
      node.addControl(ctrl);
      return node.addOutput(out);
    }
    worker(node, inputs, outputs) {
      outputs['text'] = node.data.text;
    }
  }

  class ActionNode extends Rete.Component {
    constructor() { super("Aktion"); }
    builder(node) {
      const out = new Rete.Output('action', 'Aktion');
      let ctrl = new Rete.Control('action', {
        component: class extends Rete.Control {
          constructor(emitter, key) {
            super(key);
            this.render = 'input';
            this.key = key;
            this.emitter = emitter;
            this.data = { action: 'Antworten' };
            this.putData(this.data);
          }
          mounted() { this.update(); }
          setValue(val) {
            this.data.action = val;
            this.putData(this.data);
            this.emitter.trigger('process');
          }
          update() {
            this.putData(this.key, this.data.action);
          }
          render() {
            return `<input type="text" style="width:100%;" value="${this.data.action}" oninput="this.parentNode.control.setValue(this.value)" />`;
          }
        }
      }, 'action');
      node.addControl(ctrl);
      return node.addOutput(out);
    }
    worker(node, inputs, outputs) {
      outputs['action'] = node.data.action;
    }
  }

  // Editor
  const editor = new Rete.NodeEditor('demo@0.1.0', container);
  editor.use(Rete.ConnectionPlugin);
  editor.use(Rete.AreaPlugin, { background: false });

  const textComp = new TextNode();
  const actionComp = new ActionNode();

  // Nodes erstellen
  async function createNode(comp, data, x=0, y=0) {
    const node = await comp.createNode(data);
    node.x = x; node.y = y;
    editor.addNode(node);
    return node;
  }

  // Nodes hinzufügen (auf Button klicken)
  document.getElementById('add-node').onclick = async () => {
    await createNode(textComp, { text: 'Begrüßung' }, 80, 80);
    await createNode(actionComp, { action: 'Antworten' }, 300, 200);
  };

  // Verbindung speichern
  document.getElementById('save').onclick = () => {
    const data = editor.toJSON();
    document.getElementById('output').textContent = JSON.stringify(data, null, 2);
  };

  // Beispielnodes initial
  await createNode(textComp, { text: 'Willkommen' }, 50, 50);
  await createNode(actionComp, { action: 'Antworten' }, 250, 150);
})();
</script>

</body>
</html>
